"""
Stage 2: Generate Newsletter HTML
Takes narrative JSON and creates final HTML email with dark mode support.
"""

import json
import logging
import sys
from pathlib import Path
from typing import Any, Dict

# Configure logging
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")


def format_percentage(value: float, include_sign: bool = True) -> str:
    """Format percentage with appropriate sign and color class"""
    if include_sign:
        sign = "+" if value > 0 else ""
        return f"{sign}{value:.2f}%"
    return f"{value:.2f}%"


def get_performance_color_class(value: float) -> str:
    """Return CSS class based on performance value"""
    return "positive" if value >= 0 else ""


def generate_html(narrative_data: Dict[str, Any]) -> str:
    """
    Generate email-compatible HTML from narrative JSON.
    Uses optimized table-based layout with inline styles for maximum email client compatibility.
    Matches the exact format of week7_newsletter_enhanced.html.

    Args:
        narrative_data: Dictionary containing newsletter narrative data

    Returns:
        Complete HTML string optimized for email clients (50KB, 94%+ compatibility)
    """
    week_num = narrative_data["week_number"]
    date_range = narrative_data.get("date_range", "")
    subject = narrative_data["subject_line"]
    preheader = narrative_data["preheader"]
    opening = narrative_data["opening_paragraph"]
    insights = narrative_data["key_insights"]
    perf_data = narrative_data["performance_data"]
    market_context = narrative_data["market_context"]
    benchmark = narrative_data["benchmark_comparison"]
    cta_url = narrative_data["call_to_action_url"]
    portfolio_value = perf_data.get("portfolio_value", 10000)

    # Format performance values
    weekly_change = perf_data["weekly_change"]
    total_return = perf_data["total_return"]
    weekly_sign = "+" if weekly_change >= 0 else ""
    total_sign = "+" if total_return >= 0 else ""
    weekly_color = "#22c55e" if weekly_change >= 0 else "#ef4444"
    total_color = "#4ade80" if total_return >= 0 else "#ef4444"

    # Format benchmark percentages
    portfolio_weekly = benchmark["portfolio_weekly"]
    sp500_weekly = benchmark["sp500_weekly"]
    bitcoin_weekly = benchmark["bitcoin_weekly"]
    benchmark_summary = benchmark["summary"]

    # Format top/worst performer
    top_performer = perf_data["top_performer"]
    worst_performer = perf_data["worst_performer"]

    # Determine performance descriptors
    top_perf_color = "#fbbf24"  # Gold for trophy
    top_perf_change_color = "#22c55e" if top_performer['change'] >= 0 else "#ef4444"
    worst_perf_change_color = "#4ade80" if worst_performer['change'] >= 0 else "#ef4444"
    worst_label = "MODEST GAIN" if worst_performer['change'] >= 0 else "WORST PERFORMER"

    # Parse date range for Monday-Friday format
    if "to" in date_range.lower():
        parts = date_range.upper().split(" TO ")
        if len(parts) == 2:
            formatted_date = f"{parts[0].strip()} ‚Äì {parts[1].strip()}"
        else:
            formatted_date = date_range.upper()
    else:
        formatted_date = date_range.upper()

    # Extract subject line theme (after emoji and week number)
    subject_parts = subject.split("|")
    theme = subject_parts[1].strip() if len(subject_parts) > 1 else "Performance Update"

    # Generate gradient badges for insights with icon fallbacks
    insight_icons = [
        ("database", "üíæ", "#a855f7", "#7c3aed"),  # Storage
        ("factory", "üè≠", "#3b82f6", "#2563eb"),   # Industrials
        ("laptop", "üíª", "#22c55e", "#16a34a")     # Tech
    ]

    insights_html = []
    for i, insight in enumerate(insights[:3]):  # Limit to 3 insights
        icon_name, emoji, gradient_start, gradient_end = insight_icons[i] if i < len(insight_icons) else ("chart", "üìä", "#a855f7", "#7c3aed")
        insights_html.append(
            f"""                                <!-- Insight Card {i + 1} -->
                                <tr>
                                    <td style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.12) 0%, rgba(168, 85, 247, 0.05) 100%); border-left: 4px solid #a855f7; border-radius: 0 8px 8px 0; padding: 24px; margin-bottom: 16px; border: 1px solid rgba(168, 85, 247, 0.15);">
                                        <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0">
                                            <tr>
                                                <td width="48" style="vertical-align: top; padding-right: 16px;">
                                                    <table role="presentation" width="48" height="48" cellspacing="0" cellpadding="0" border="0" style="background: linear-gradient(135deg, {gradient_start} 0%, {gradient_end} 100%); border-radius: 10px;">
                                                        <tr>
                                                            <td align="center" valign="middle" style="text-align: center;">
                                                                <!--[if mso]><div style="font-size: 24px;">{emoji}</div><![endif]-->
                                                                <!--[if !mso]><!-->
                                                                <img src="https://api.iconify.design/mdi/{icon_name}.svg?color=white" alt="{insight['title']}" width="28" height="28" style="display: block; margin: 0 auto;" />
                                                                <!--<![endif]-->
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td style="vertical-align: top;">
                                                    <div style="font-size: 18px; font-weight: 600; color: #ffffff; padding-bottom: 8px;">
                                                        {insight['title']}
                                                    </div>
                                                    <div style="font-size: 15px; color: #9ca3af; line-height: 1.6;">
                                                        {insight['description']}
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                                <tr><td height="16"></td></tr>"""
        )

    insights_section = "\n".join(insights_html)

    # Determine banner colors based on performance
    banner_gradient_top = "linear-gradient(90deg, #22c55e 0%, #4ade80 100%)" if weekly_change >= 0 else "linear-gradient(90deg, #ef4444 0%, #dc2626 100%)"
    banner_border_color = "rgba(34, 197, 94, 0.2)" if weekly_change >= 0 else "rgba(239, 68, 68, 0.2)"

    # Calculate progress bar widths (scaled to 100%)
    weekly_progress = min(abs(weekly_change) * 20, 100)  # Scale factor
    total_progress = min(abs(total_return) * 10, 100)

    # Benchmark progress bars (relative to portfolio)
    max_benchmark = max(abs(portfolio_weekly), abs(sp500_weekly), abs(bitcoin_weekly))
    sp500_progress = (abs(sp500_weekly) / max_benchmark * 100) if max_benchmark > 0 else 20
    bitcoin_progress = (abs(bitcoin_weekly) / max_benchmark * 100) if max_benchmark > 0 else 10

    # Email-optimized HTML - matches week7_newsletter_enhanced.html exactly
    html = f"""<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>{subject}</title>
    <!--[if mso]>
    <noscript>
    <xml>
    <o:OfficeDocumentSettings>
    <o:PixelsPerInch>96</o:PixelsPerInch>
    </o:OfficeDocumentSettings>
    </xml>
    </noscript>
    <![endif]-->
    <style type="text/css">
        body {{
            margin: 0;
            padding: 0;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }}
        table {{
            border-collapse: collapse;
            mso-table-lspace: 0pt;
            mso-table-rspace: 0pt;
        }}
        img {{
            border: 0;
            height: auto;
            line-height: 100%;
            outline: none;
            text-decoration: none;
            -ms-interpolation-mode: bicubic;
        }}
        a {{
            text-decoration: none;
        }}
        .mobile-hide {{
            display: none !important;
        }}
        @media only screen and (max-width: 600px) {{
            .mobile-center {{
                text-align: center !important;
            }}
            .mobile-full-width {{
                width: 100% !important;
            }}
        }}
    </style>
</head>
<body style="margin: 0; padding: 0; background-color: #000000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;">
    <!-- Outer wrapper table -->
    <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0" style="background-color: #000000;">
        <tr>
            <td align="center" style="padding: 40px 20px;">
                <!-- Main container table (680px max-width) -->
                <table role="presentation" width="680" cellspacing="0" cellpadding="0" border="0" style="max-width: 680px; width: 100%; background-color: #111111;">

                    <!-- Header -->
                    <tr>
                        <td align="center" style="background-color: #1a1a1a; padding: 48px 32px; border-bottom: 3px solid #6b7280;">
                            <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0">
                                <tr>
                                    <td align="center" style="font-size: 12px; text-transform: uppercase; letter-spacing: 0.15em; color: #9ca3af; font-weight: 600; padding-bottom: 16px;">
                                        QUANTUM INVESTOR DIGEST
                                    </td>
                                </tr>
                                <tr>
                                    <td align="center" style="font-size: 24px; font-weight: 700; color: #ffffff; line-height: 1.3; padding-bottom: 12px;">
                                        {subject}
                                    </td>
                                </tr>
                                <tr>
                                    <td align="center" style="font-size: 13px; color: #9ca3af; letter-spacing: 0.02em;">
                                        {formatted_date}
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>

                    <!-- Performance Banner -->
                    <tr>
                        <td style="background-color: #111111; padding: 24px 32px;">
                            <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0" style="background-color: #1a1a1a; border-left: 3px solid {('#22c55e' if weekly_change >= 0 else '#ef4444')};">
                                <tr>
                                    <td style="padding: 24px;">
                                        <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0">
                                            <tr>
                                                <td width="50%" style="padding-right: 20px; vertical-align: top;">
                                                    <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0">
                                                        <tr>
                                                            <td style="font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; padding-bottom: 8px;">
                                                                Week {week_num} Performance
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td style="font-size: 40px; font-weight: 700; color: {('#22c55e' if weekly_change >= 0 else '#ef4444')}; line-height: 1; padding-bottom: 4px;">
                                                                {weekly_sign}{weekly_change:.2f}%
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td style="font-size: 13px; color: #6b7280;">
                                                                vs. prior week
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td width="50%" style="padding-left: 20px; border-left: 1px solid #2a2a2a; vertical-align: top;">
                                                    <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0">
                                                        <tr>
                                                            <td style="font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; padding-bottom: 8px;">
                                                                Total Return
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td style="font-size: 32px; font-weight: 700; color: {('#22c55e' if total_return >= 0 else '#ef4444')}; line-height: 1; padding-bottom: 4px;">
                                                                {total_sign}{total_return:.2f}%
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td style="font-size: 13px; color: #6b7280;">
                                                                since inception
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>

                    <!-- Main Content -->
                    <tr>
                        <td style="padding: 40px 32px; background-color: #111111;">
                            <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0">

                                <!-- Greeting Section -->
                                <tr>
                                    <td style="background-color: #1a1a1a; padding: 24px; border-left: 3px solid #a855f7; margin-bottom: 32px;">
                                        <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0">
                                            <tr>
                                                <td style="font-size: 16px; color: #9ca3af; padding-bottom: 8px;">
                                                    Welcome back to the Quantum Investor Digest update
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="font-size: 18px; color: #ffffff; line-height: 1.5; font-weight: 500;">
                                                    {preheader}
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>

                                <!-- Spacing -->
                                <tr><td height="32"></td></tr>

                                <!-- Opening Paragraph -->
                                <tr>
                                    <td style="font-size: 16px; line-height: 1.75; color: #E0E0E0; padding-bottom: 40px;">
                                        {opening}
                                    </td>
                                </tr>

                                <!-- Key Insights Title -->
                                <tr>
                                    <td style="font-size: 22px; font-weight: 700; color: #a855f7; padding: 20px 0 24px 0; letter-spacing: -0.02em;">
                                        üìä Key Insights
                                    </td>
                                </tr>

{insights_section}

                                <!-- Performance Highlights Title -->
                                <tr>
                                    <td style="font-size: 22px; font-weight: 700; color: #a855f7; padding: 40px 0 24px 0; letter-spacing: -0.02em;">
                                        üéØ Performance Highlights
                                    </td>
                                </tr>

                                <!-- Performance Grid (Best/Worst) -->
                                <tr>
                                    <td>
                                        <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0">
                                            <tr>
                                                <!-- Best Performer -->
                                                <td width="48%" style="background-color: #1a1a1a; border: 1px solid #222222; padding: 24px 20px; text-align: center; vertical-align: top;">
                                                    <div style="font-weight: 700; color: #a855f7; font-size: 15px; letter-spacing: 0.05em; padding-bottom: 8px;">
                                                        {top_performer['ticker']}
                                                    </div>
                                                    <div style="font-size: 26px; font-weight: 700; color: {'#4ade80' if top_performer['change'] >= 0 else '#ef4444'}; padding: 8px 0;">
                                                        {format_percentage(top_performer['change'])}
                                                    </div>
                                                    <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.08em; padding-top: 8px;">
                                                        BEST PERFORMER
                                                    </div>
                                                </td>
                                                <td width="4%"></td>
                                                <!-- Worst Performer -->
                                                <td width="48%" style="background-color: #1a1a1a; border: 1px solid #222222; padding: 24px 20px; text-align: center; vertical-align: top;">
                                                    <div style="font-weight: 700; color: #a855f7; font-size: 15px; letter-spacing: 0.05em; padding-bottom: 8px;">
                                                        {worst_performer['ticker']}
                                                    </div>
                                                    <div style="font-size: 26px; font-weight: 700; color: {'#4ade80' if worst_performer['change'] >= 0 else '#ef4444'}; padding: 8px 0;">
                                                        {format_percentage(worst_performer['change'])}
                                                    </div>
                                                    <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.08em; padding-top: 8px;">
                                                        WORST PERFORMER
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>

                                <!-- Spacing -->
                                <tr><td height="32"></td></tr>

                                <!-- Market Context -->
                                <tr>
                                    <td style="background-color: rgba(168, 85, 247, 0.08); border: 1px solid rgba(168, 85, 247, 0.2); padding: 24px;">
                                        <div style="font-size: 17px; font-weight: 600; color: #a855f7; padding-bottom: 12px;">
                                            üåç Market Context & Outlook
                                        </div>
                                        <div style="font-size: 15px; color: #9ca3af; line-height: 1.7;">
                                            {market_context}
                                        </div>
                                    </td>
                                </tr>

                                <!-- Benchmark Title -->
                                <tr>
                                    <td style="font-size: 22px; font-weight: 700; color: #a855f7; padding: 40px 0 24px 0; letter-spacing: -0.02em;">
                                        üìä Benchmark Comparison
                                    </td>
                                </tr>

                                <!-- Benchmark Summary -->
                                <tr>
                                    <td style="background-color: #1a1a1a; border-left: 3px solid #a855f7; padding: 20px; margin: 24px 0;">
                                        <div style="font-size: 15px; color: #9ca3af; line-height: 1.7;">
                                            <strong style="color: #E0E0E0;">Performance Summary:</strong> {benchmark_summary}
                                        </div>
                                    </td>
                                </tr>

                                <!-- Spacing -->
                                <tr><td height="24"></td></tr>

                                <!-- Benchmark Grid (3 columns) -->
                                <tr>
                                    <td>
                                        <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0">
                                            <tr>
                                                <!-- Portfolio -->
                                                <td width="32%" style="background-color: #1a1a1a; border: 1px solid #222222; padding: 24px 20px; text-align: center; vertical-align: top;">
                                                    <div style="font-weight: 700; color: #a855f7; font-size: 15px; letter-spacing: 0.05em; padding-bottom: 8px;">
                                                        Portfolio
                                                    </div>
                                                    <div style="font-size: 26px; font-weight: 700; color: {'#4ade80' if portfolio_weekly >= 0 else '#ef4444'}; padding: 8px 0;">
                                                        {format_percentage(portfolio_weekly)}
                                                    </div>
                                                    <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.08em; padding-top: 8px;">
                                                        WEEKLY
                                                    </div>
                                                </td>
                                                <td width="2%"></td>
                                                <!-- S&P 500 -->
                                                <td width="32%" style="background-color: #1a1a1a; border: 1px solid #222222; padding: 24px 20px; text-align: center; vertical-align: top;">
                                                    <div style="font-weight: 700; color: #a855f7; font-size: 15px; letter-spacing: 0.05em; padding-bottom: 8px;">
                                                        S&P 500
                                                    </div>
                                                    <div style="font-size: 26px; font-weight: 700; color: {'#4ade80' if sp500_weekly >= 0 else '#ef4444'}; padding: 8px 0;">
                                                        {format_percentage(sp500_weekly)}
                                                    </div>
                                                    <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.08em; padding-top: 8px;">
                                                        WEEKLY
                                                    </div>
                                                </td>
                                                <td width="2%"></td>
                                                <!-- Bitcoin -->
                                                <td width="32%" style="background-color: #1a1a1a; border: 1px solid #222222; padding: 24px 20px; text-align: center; vertical-align: top;">
                                                    <div style="font-weight: 700; color: #a855f7; font-size: 15px; letter-spacing: 0.05em; padding-bottom: 8px;">
                                                        Bitcoin
                                                    </div>
                                                    <div style="font-size: 26px; font-weight: 700; color: {'#4ade80' if bitcoin_weekly >= 0 else '#ef4444'}; padding: 8px 0;">
                                                        {format_percentage(bitcoin_weekly)}
                                                    </div>
                                                    <div style="font-size: 13px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.08em; padding-top: 8px;">
                                                        WEEKLY
                                                    </div>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>

                                <!-- CTA Button -->
                                <tr>
                                    <td align="center" style="padding: 40px 0 32px 0;">
                                        <a href="{cta_url}" style="display: inline-block; background-color: #7c3aed; color: #ffffff; padding: 16px 40px; text-decoration: none; font-weight: 600; font-size: 16px; letter-spacing: 0.01em;">
                                            üìà View Full Portfolio Analysis
                                        </a>
                                    </td>
                                </tr>

                            </table>
                        </td>
                    </tr>

                    <!-- Footer -->
                    <tr>
                        <td style="background-color: #000000; border-top: 1px solid #1a1a1a; padding: 32px; text-align: center;">
                            <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0">
                                <tr>
                                    <td align="center" style="font-size: 16px; font-weight: 600; color: #a855f7; padding-bottom: 12px; letter-spacing: 0.02em;">
                                        Quantum Investor Digest
                                    </td>
                                </tr>
                                <tr>
                                    <td align="center" style="font-size: 13px; color: #6b7280; line-height: 1.6; padding-bottom: 12px;">
                                        This newsletter is for informational purposes only and does not constitute investment advice.
                                    </td>
                                </tr>
                                <tr>
                                    <td align="center" style="font-size: 13px; color: #6b7280; line-height: 1.6; padding-bottom: 4px;">
                                        You're receiving this because you subscribed at quantuminvestor.net
                                    </td>
                                </tr>
                                <tr>
                                    <td align="center" style="font-size: 13px; color: #6b7280; line-height: 1.6; padding-bottom: 16px;">
                                        Sent to {{{{SUBSCRIBER_EMAIL}}}}
                                    </td>
                                </tr>
                                <tr>
                                    <td align="center" style="font-size: 13px; color: #6b7280; line-height: 1.6;">
                                        <a href="https://quantuminvestor.net/newsletters/week{week_num}_newsletter.html" style="color: #6b7280; text-decoration: underline;">View in Browser</a>
                                        <span style="color: #6b7280; margin: 0 8px;">|</span>
                                        <a href="https://api.quantuminvestor.net/api/Unsubscribe?email={{{{SUBSCRIBER_EMAIL}}}}" style="color: #6b7280; text-decoration: underline;">Unsubscribe</a>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>

                </table>
            </td>
        </tr>
    </table>
</body>
</html>"""

    return html


def main():
    """Main execution function"""
    if len(sys.argv) < 2:
        print("Usage: python generate_newsletter_html.py <week_number>")
        sys.exit(1)

    try:
        week_num = int(sys.argv[1])
    except ValueError:
        print(f"Error: Invalid week number '{sys.argv[1]}'. Must be an integer.")
        sys.exit(1)

    # Paths
    base_dir = Path(__file__).parent.parent
    json_path = base_dir / "newsletters" / f"week{week_num}_narrative.json"
    output_path = base_dir / "newsletters" / f"week{week_num}_newsletter.html"

    # Validate JSON exists
    if not json_path.exists():
        logging.error(f"Narrative JSON not found: {json_path}")
        print(f"‚ùå Error: {json_path} does not exist.")
        print(f"   Run Stage 1 first: python scripts/generate_newsletter_narrative.py {week_num}")
        sys.exit(1)

    # Load narrative data
    logging.info(f"Loading narrative data from {json_path}")
    try:
        with open(json_path, "r", encoding="utf-8") as f:
            narrative_data = json.load(f)
    except json.JSONDecodeError as e:
        logging.error(f"Invalid JSON in {json_path}: {e}")
        print(f"‚ùå Error: Invalid JSON format in {json_path}")
        sys.exit(1)

    # Generate HTML
    logging.info(f"Generating HTML for Week {week_num}")
    html_content = generate_html(narrative_data)

    # Save HTML
    logging.info(f"Saving HTML to {output_path}")
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(html_content)

    # Success message
    print("\n" + "=" * 60)
    print("üìß STAGE 2 COMPLETE")
    print("=" * 60)
    print(f"‚úÖ Newsletter HTML created")
    print(f"üìÇ Output file: newsletters/week{week_num}_newsletter.html")
    print(f"üìù Subject: {narrative_data['subject_line']}")
    print(f"üé® Professional design with light/dark mode support")
    print("\nüîç NEXT STEPS:")
    print(f"1. Open newsletters/week{week_num}_newsletter.html in browser to preview")
    print(f"2. Test both light and dark modes by switching OS theme")
    print(f"3. Send test email via your email service provider")
    print("=" * 60)

    logging.info("Newsletter generation complete")


if __name__ == "__main__":
    main()
